<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Somaiya Guessr - Backend Test</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        
        .content {
            padding: 30px;
        }
        
        .section {
            margin-bottom: 40px;
            padding: 25px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 5px solid #667eea;
        }
        
        .section h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.5rem;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }
        
        input[type="text"],
        input[type="number"],
        input[type="file"],
        select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #2ed573, #1e90ff);
        }
        
        .response {
            margin-top: 15px;
            padding: 15px;
            border-radius: 8px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .response.success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        
        .response.error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .status {
            background: #e3f2fd;
            border: 1px solid #bbdefb;
            color: #1565c0;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .photo-preview {
            max-width: 200px;
            max-height: 200px;
            border-radius: 8px;
            margin-top: 10px;
        }
        
        .coordinate-input {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        
        .socket-status {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #333;
            color: white;
            padding: 10px 15px;
            border-radius: 20px;
            font-size: 14px;
        }
        
        .socket-status.connected {
            background: #2ed573;
        }
        
        .socket-status.disconnected {
            background: #ff6b6b;
        }
        
        code {
            background: #f1f3f4;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Monaco', 'Courier New', monospace;
        }
    </style>
</head>
<body>
    <div class="socket-status" id="socketStatus">Socket: Disconnected</div>
    
    <div class="container">
        <div class="header">
            <h1>üéØ Somaiya Guessr</h1>
            <p>Backend Testing Interface</p>
        </div>
        
        <div class="content">
            <!-- API Status -->
            <div class="section">
                <h2>üöÄ API Status</h2>
                <button class="btn btn-success" onclick="checkStatus()">Check Server Status</button>
                <div id="statusResponse" class="response"></div>
            </div>
            
            <!-- Admin Section -->
            <div class="section">
                <h2>üîß Admin Functions</h2>
                
                <div class="grid">
                    <div>
                        <h3>Upload Photo</h3>
                        <form id="uploadForm">
                            <div class="form-group">
                                <label for="photoFile">Select Photo:</label>
                                <input type="file" id="photoFile" name="photo" accept="image/*" required>
                                <img id="photoPreview" class="photo-preview" style="display:none;">
                            </div>
                            
                            <div class="form-group">
                                <label>Coordinates (click on image to set):</label>
                                <div class="coordinate-input">
                                    <input type="number" id="coordX" name="coordX" placeholder="X coordinate" required>
                                    <input type="number" id="coordY" name="coordY" placeholder="Y coordinate" required>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label for="location">Location Description:</label>
                                <input type="text" id="location" name="location" placeholder="e.g., Main Building Entrance">
                            </div>
                            
                            <div class="form-group">
                                <label for="difficulty">Difficulty:</label>
                                <select id="difficulty" name="difficulty">
                                    <option value="easy">Easy</option>
                                    <option value="medium" selected>Medium</option>
                                    <option value="hard">Hard</option>
                                </select>
                            </div>
                            
                            <button type="submit" class="btn">Upload Photo</button>
                        </form>
                    </div>
                    
                    <div>
                        <h3>Photo Management</h3>
                        <button class="btn" onclick="getAllPhotos()">Load All Photos</button>
                        <div id="photosList"></div>
                    </div>
                </div>
                
                <div id="uploadResponse" class="response"></div>
            </div>
            
            <!-- Game Testing -->
            <div class="section">
                <h2>üéÆ Game Testing</h2>
                
                <div class="grid">
                    <div>
                        <h3>Room Management</h3>
                        <button class="btn" onclick="createRoom()">Create New Room</button>
                        <div class="form-group" style="margin-top: 15px;">
                            <input type="text" id="joinRoomId" placeholder="Enter Room ID">
                            <button class="btn" onclick="joinRoom()">Join Room</button>
                        </div>
                        <button class="btn btn-success" onclick="getRoomStats()">Get Room Stats</button>
                        <button class="btn btn-danger" onclick="cleanupRooms()">Cleanup Inactive Rooms</button>
                        <div id="roomResponse" class="response"></div>
                    </div>
                    
                    <div>
                        <h3>Game Actions</h3>
                        <button class="btn" onclick="getRandomPhoto()">Get Random Photo</button>
                        <button class="btn" onclick="nextRound()">Next Round</button>
                        <div class="form-group" style="margin-top: 15px;">
                            <div class="coordinate-input">
                                <input type="number" id="guessX" placeholder="Guess X">
                                <input type="number" id="guessY" placeholder="Guess Y">
                            </div>
                            <input type="text" id="playerName" placeholder="Player Name" style="margin-top: 10px;">
                            <button class="btn btn-success" onclick="submitGuess()">Submit Guess</button>
                        </div>
                        <div id="gameResponse" class="response"></div>
                    </div>
                </div>
            </div>
            
            <!-- Socket.io Testing -->
            <div class="section">
                <h2>üîå Socket.io Testing</h2>
                
                <div class="status" id="socketInfo">
                    Socket not connected. Click connect to start.
                </div>
                
                <div class="grid">
                    <div>
                        <h3>Connection</h3>
                        <button class="btn btn-success" onclick="connectSocket()">Connect Socket</button>
                        <button class="btn btn-danger" onclick="disconnectSocket()">Disconnect</button>
                        
                        <div class="form-group" style="margin-top: 15px;">
                            <input type="text" id="socketRoomId" placeholder="Room ID">
                            <input type="text" id="socketPlayerName" placeholder="Player Name">
                            <button class="btn" onclick="joinRoomSocket()">Join Room (Socket)</button>
                        </div>
                    </div>
                    
                    <div>
                        <h3>Socket Actions</h3>
                        <div class="form-group">
                            <div class="coordinate-input">
                                <input type="number" id="socketGuessX" placeholder="Guess X">
                                <input type="number" id="socketGuessY" placeholder="Guess Y">
                            </div>
                            <button class="btn btn-success" onclick="submitSocketGuess()">Submit Guess (Socket)</button>
                        </div>
                    </div>
                </div>
                
                <div id="socketResponse" class="response"></div>
            </div>
            
            <!-- Current Game State -->
            <div class="section">
                <h2>üìä Current Game State</h2>
                <div id="gameState">
                    <p>No active game session</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let socket = null;
        let currentRoomId = null;
        let currentPlayerName = null;
        
        // API Base URL
        const API_BASE = 'http://localhost:3000'+ '/api';
        
        // Utility functions
        function showResponse(elementId, data, isError = false) {
            const element = document.getElementById(elementId);
            element.className = `response ${isError ? 'error' : 'success'}`;
            element.innerHTML = `<pre>${JSON.stringify(data, null, 2)}</pre>`;
            element.style.display = 'block';
        }
        
        function updateGameState(data) {
            const gameStateEl = document.getElementById('gameState');
            gameStateEl.innerHTML = `
                <div style="display: grid; gap: 15px; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));">
                    <div><strong>Room ID:</strong> ${data.roomId || 'None'}</div>
                    <div><strong>Current Round:</strong> ${data.currentRound || 'N/A'} / ${data.totalRounds || 'N/A'}</div>
                    <div><strong>Game State:</strong> ${data.gameState || 'N/A'}</div>
                    <div><strong>Player:</strong> ${currentPlayerName || 'None'}</div>
                    ${data.photo ? `<div><strong>Photo:</strong> <a href="${data.photo.imageUrl}" target="_blank">View Image</a></div>` : ''}
                </div>
            `;
        }
        
        // API Testing Functions
        async function checkStatus() {
            try {
                const response = await fetch('http://localhost:3000');
                const data = await response.json();
                showResponse('statusResponse', data);
            } catch (error) {
                showResponse('statusResponse', { error: error.message }, true);
            }
        }
        
        // Photo upload handling
        document.getElementById('photoFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const preview = document.getElementById('photoPreview');
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                    
                    // Add click listener to set coordinates
                    preview.onclick = function(event) {
                        const rect = preview.getBoundingClientRect();
                        const x = Math.round(event.clientX - rect.left);
                        const y = Math.round(event.clientY - rect.top);
                        
                        document.getElementById('coordX').value = x;
                        document.getElementById('coordY').value = y;
                        
                        console.log(`Coordinates set: (${x}, ${y})`);
                    };
                };
                reader.readAsDataURL(file);
            }
        });
        
        // Upload form handling
        document.getElementById('uploadForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData();
            const fileInput = document.getElementById('photoFile');
            const file = fileInput.files[0];
            
            if (!file) {
                showResponse('uploadResponse', { error: 'Please select a photo' }, true);
                return;
            }
            
            formData.append('photo', file);
            formData.append('coordX', document.getElementById('coordX').value);
            formData.append('coordY', document.getElementById('coordY').value);
            formData.append('location', document.getElementById('location').value);
            formData.append('difficulty', document.getElementById('difficulty').value);
            
            try {
                const response = await fetch(`${API_BASE}/admin/upload-photo`, {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                showResponse('uploadResponse', data, !response.ok);
                
                if (response.ok) {
                    document.getElementById('uploadForm').reset();
                    document.getElementById('photoPreview').style.display = 'none';
                }
            } catch (error) {
                showResponse('uploadResponse', { error: error.message }, true);
            }
        });
        
        async function getAllPhotos() {
            try {
                const response = await fetch(`${API_BASE}/admin/photos`);
                const data = await response.json();
                
                const photosListEl = document.getElementById('photosList');
                if (data.photos && data.photos.length > 0) {
                    photosListEl.innerHTML = `
                        <h4>Uploaded Photos (${data.photos.length}):</h4>
                        <div style="display: grid; gap: 15px; max-height: 300px; overflow-y: auto; margin-top: 10px;">
                            ${data.photos.map(photo => `
                                <div style="border: 1px solid #ddd; padding: 10px; border-radius: 5px; background: white;">
                                    <div style="display: grid; grid-template-columns: 100px 1fr auto; gap: 10px; align-items: center;">
                                        <img src="${photo.imageUrl}" style="width: 100px; height: 60px; object-fit: cover; border-radius: 4px;">
                                        <div>
                                            <div><strong>${photo.location || 'No location'}</strong></div>
                                            <div>Difficulty: ${photo.difficulty}</div>
                                            <div>Coordinates: (${photo.coordX}, ${photo.coordY})</div>
                                        </div>
                                        <button class="btn btn-danger" onclick="deletePhoto('${photo._id}')" style="margin: 0;">Delete</button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                } else {
                    photosListEl.innerHTML = '<p>No photos uploaded yet.</p>';
                }
                
                showResponse('uploadResponse', data, !response.ok);
            } catch (error) {
                showResponse('uploadResponse', { error: error.message }, true);
            }
        }
        
        async function deletePhoto(photoId) {
            if (!confirm('Are you sure you want to delete this photo?')) return;
            
            try {
                const response = await fetch(`${API_BASE}/admin/photos/${photoId}`, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                showResponse('uploadResponse', data, !response.ok);
                
                if (response.ok) {
                    getAllPhotos(); // Refresh the list
                }
            } catch (error) {
                showResponse('uploadResponse', { error: error.message }, true);
            }
        }
        
        // Game Testing Functions
        async function createRoom() {
            try {
                const response = await fetch(`${API_BASE}/game/create-room`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const data = await response.json();
                showResponse('roomResponse', data, !response.ok);
                
                if (response.ok) {
                    currentRoomId = data.roomId;
                    updateGameState(data);
                }
            } catch (error) {
                showResponse('roomResponse', { error: error.message }, true);
            }
        }
        
        async function joinRoom() {
            const roomId = document.getElementById('joinRoomId').value;
            if (!roomId) {
                showResponse('roomResponse', { error: 'Please enter a room ID' }, true);
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/game/join-room`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ roomId })
                });
                
                const data = await response.json();
                showResponse('roomResponse', data, !response.ok);
                
                if (response.ok) {
                    currentRoomId = roomId;
                    updateGameState(data);
                }
            } catch (error) {
                showResponse('roomResponse', { error: error.message }, true);
            }
        }
        
        async function getRoomStats() {
            try {
                const response = await fetch(`${API_BASE}/game/room-stats`);
                const data = await response.json();
                showResponse('roomResponse', data, !response.ok);
            } catch (error) {
                showResponse('roomResponse', { error: error.message }, true);
            }
        }
        
        async function cleanupRooms() {
            try {
                const response = await fetch(`${API_BASE}/game/cleanup-rooms`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const data = await response.json();
                showResponse('roomResponse', data, !response.ok);
            } catch (error) {
                showResponse('roomResponse', { error: error.message }, true);
            }
        }
        
        async function getRandomPhoto() {
            try {
                const response = await fetch(`${API_BASE}/game/random-photo`);
                const data = await response.json();
                showResponse('gameResponse', data, !response.ok);
            } catch (error) {
                showResponse('gameResponse', { error: error.message }, true);
            }
        }
        
        async function submitGuess() {
            const guessX = document.getElementById('guessX').value;
            const guessY = document.getElementById('guessY').value;
            const playerName = document.getElementById('playerName').value;
            
            if (!guessX || !guessY || !playerName || !currentRoomId) {
                showResponse('gameResponse', { 
                    error: 'Please fill in all fields and join a room first' 
                }, true);
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/game/submit-guess`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        roomId: currentRoomId,
                        guessX: parseFloat(guessX),
                        guessY: parseFloat(guessY),
                        playerName
                    })
                });
                
                const data = await response.json();
                showResponse('gameResponse', data, !response.ok);
                
                if (response.ok) {
                    currentPlayerName = playerName;
                }
            } catch (error) {
                showResponse('gameResponse', { error: error.message }, true);
            }
        }
        
        async function nextRound() {
            if (!currentRoomId) {
                showResponse('gameResponse', { error: 'Please join a room first' }, true);
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/game/next-round`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ roomId: currentRoomId })
                });
                
                const data = await response.json();
                showResponse('gameResponse', data, !response.ok);
                
                if (response.ok) {
                    updateGameState(data);
                }
            } catch (error) {
                showResponse('gameResponse', { error: error.message }, true);
            }
        }
        
        // Socket.io Functions
        function connectSocket() {
            if (socket) {
                socket.disconnect();
            }
            
            socket = io();
            
            socket.on('connect', () => {
                updateSocketStatus('connected');
                showSocketMessage('Socket connected successfully');
            });
            
            socket.on('disconnect', () => {
                updateSocketStatus('disconnected');
                showSocketMessage('Socket disconnected');
            });
            
            socket.on('room-joined', (data) => {
                showSocketMessage(`Room joined: ${JSON.stringify(data, null, 2)}`);
                currentRoomId = data.roomId;
                updateGameState(data);
            });
            
            socket.on('player-joined', (data) => {
                showSocketMessage(`Player joined: ${JSON.stringify(data, null, 2)}`);
            });
            
            socket.on('guess-result', (data) => {
                showSocketMessage(`Guess result: ${JSON.stringify(data, null, 2)}`);
            });
            
            socket.on('player-guessed', (data) => {
                showSocketMessage(`Player guessed: ${JSON.stringify(data, null, 2)}`);
            });
            
            socket.on('error', (data) => {
                showSocketMessage(`Error: ${JSON.stringify(data, null, 2)}`, true);
            });
        }
        
        function disconnectSocket() {
            if (socket) {
                socket.disconnect();
                socket = null;
                updateSocketStatus('disconnected');
                showSocketMessage('Socket disconnected manually');
            }
        }
        
        function joinRoomSocket() {
            const roomId = document.getElementById('socketRoomId').value;
            const playerName = document.getElementById('socketPlayerName').value;
            
            if (!socket || !socket.connected) {
                showSocketMessage('Please connect socket first', true);
                return;
            }
            
            if (!roomId || !playerName) {
                showSocketMessage('Please enter room ID and player name', true);
                return;
            }
            
            socket.emit('join-room', { roomId, playerName });
            currentPlayerName = playerName;
        }
        
        function submitSocketGuess() {
            const guessX = document.getElementById('socketGuessX').value;
            const guessY = document.getElementById('socketGuessY').value;
            
            if (!socket || !socket.connected) {
                showSocketMessage('Please connect socket first', true);
                return;
            }
            
            if (!currentRoomId || !currentPlayerName || !guessX || !guessY) {
                showSocketMessage('Please join a room and fill in coordinates', true);
                return;
            }
            
            socket.emit('submit-guess', {
                roomId: currentRoomId,
                guessX: parseFloat(guessX),
                guessY: parseFloat(guessY),
                playerName: currentPlayerName
            });
        }
        
        function updateSocketStatus(status) {
            const statusEl = document.getElementById('socketStatus');
            const infoEl = document.getElementById('socketInfo');
            
            statusEl.textContent = `Socket: ${status === 'connected' ? 'Connected' : 'Disconnected'}`;
            statusEl.className = `socket-status ${status}`;
            
            infoEl.innerHTML = status === 'connected' 
                ? '<strong>‚úÖ Socket Connected</strong> - Real-time features are active'
                : '<strong>‚ùå Socket Disconnected</strong> - Real-time features are inactive';
        }
        
        function showSocketMessage(message, isError = false) {
            const responseEl = document.getElementById('socketResponse');
            const timestamp = new Date().toLocaleTimeString();
            const newMessage = `[${timestamp}] ${message}`;
            
            responseEl.className = `response ${isError ? 'error' : 'success'}`;
            responseEl.innerHTML = responseEl.innerHTML 
                ? responseEl.innerHTML + '\n' + newMessage
                : newMessage;
            responseEl.scrollTop = responseEl.scrollHeight;
            responseEl.style.display = 'block';
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            checkStatus();
            updateSocketStatus('disconnected');
        });
    </script>
</body>
</html>